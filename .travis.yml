---
language: java
os: linux
dist: xenial
install: true

addons:
  apt:
    packages:
    - wine
    - xvfb

jdk:
  - openjdk8

script: "date"

before_install:
  - cd client
  - wget http://files.jrsoftware.org/is/5/innosetup-5.6.1.exe
  - wineboot --update
  - Xvfb :0 -screen 0 1024x768x16 &
  - DISPLAY=:0.0 wine innosetup-5.6.1.exe /VERYSILENT /SUPPRESSMSGBOXES

before_deploy:
  - "export TITLE=testtitle"
  - "export BODY=testbody"
  - "zip -r tracks.zip tracks/*"
  - "cd client ; ant compile ; wine '/home/travis/.wine/drive_c/Program Files (x86)/Inno Setup 5/iscc.exe' /dMyAppVersion=1.0.0 client.iss /O /F /q'Client' ; cd .."
  - "cd server ; ant compile ; cd .."
  - "cd editor ; ant compile ; cd .."

jobs:
  include:
    - stage: compile
      name: "Client"
      script: "cd client ; ant compile"
    - name: "Server"
      script: "cd server ; ant compile"
    - name: "Editor"
      script: "cd editor ; ant compile"
    - stage: release
      deploy:
        provider: releases
        token: $GitHub_Token
        name: $TITLE
        release_notes: $BODY
        file:
          - "server/server.jar"
          - "client/client.jar"
          - "editor/editor.jar"
          - "tracks.zip"
        cleanup: false
        on:
          tags: true
